<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Infosk√¶rm ‚Äì N√∏rholm</title>
  <style>
    :root{
      --bg:#0f1115;
      --panel:#161a22;
      --text:#e9edf3;
      --muted:#a7b0c0;
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    html,body{
      height:100%;
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      height:100%;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      padding:14px;
    }

    .card{
      background:var(--panel);
      border-radius:var(--radius);
      padding:26px 22px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      min-height:0;
      display:flex;
      flex-direction:column;
    }

    .center{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      gap:14px;
    }

    .headline{
      font-size:52px;
      font-weight:900;
      line-height:1.05;
      margin:0;
      color:var(--text);
    }

    .dateLine{
      font-size:32px;
      font-weight:800;
      margin:0;
      color:var(--text);
      opacity:.95;
    }

    .bigTime{
      font-size:92px;
      font-weight:900;
      line-height:1.02;
      margin:0;
      letter-spacing: .5px;
    }

    .dayPart{
      font-size:38px;
      font-weight:900;
      margin:0;
      opacity:.98;
    }

    .weatherIcon{
      font-size:86px;
      line-height:1;
      margin-top:4px;
    }

    .bigTemp{
      font-size:92px;
      font-weight:900;
      line-height:1.02;
      margin:0;
    }

    .weatherDesc{
      font-size:32px;
      font-weight:900;
      margin:0;
      opacity:.95;
    }

    .rightFooter{
      display:flex;
      justify-content:flex-end;
      margin-top:auto;
      padding-top:10px;
    }
    .updated{
      font-size:16px;
      font-style:italic;
      color:var(--muted);
      opacity:.9;
      white-space:nowrap;
    }

    @media (max-width: 900px){
      .wrap{ grid-template-columns: 1fr; }
      .headline{ font-size:46px; }
      .dateLine, .weatherDesc{ font-size:30px; }
      .bigTime, .bigTemp{ font-size:84px; }
      .weatherIcon{ font-size:78px; }
      .dayPart{ font-size:34px; }
    }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- VENSTRE: UR -->
    <section class="card" aria-label="Ur">
      <div class="center">
        <h1 class="headline" id="weekdayBig">‚Äî</h1>
        <p class="dateLine" id="dateLine">‚Äî</p>
        <p class="bigTime" id="timeLine">‚Äî:‚Äî</p>
        <p class="dayPart" id="dayPartLine">‚Äî</p>
      </div>
    </section>

    <!-- H√òJRE: VEJR -->
    <section class="card" aria-label="Vejr">
      <div class="center">
        <h1 class="headline">N√∏rholm</h1>
        <p class="weatherDesc" id="weatherSummary">Henter vejr‚Ä¶</p>
        <div class="weatherIcon" id="weatherIcon">‚õÖ</div>
        <p class="bigTemp" id="tempLine">‚Äî¬∞</p>
      </div>

      <div class="rightFooter">
        <div class="updated" id="updatedLine">Sidst opdateret: ‚Äî</div>
      </div>
    </section>

  </div>

<script>
  // --- FAST LOKATION: N√òRHOLM (ca.)
  const LAT = 57.037145;
  const LON = 9.737577;

  // --- UR / DATO
  const dkWeekdays = ["S√∏ndag","Mandag","Tirsdag","Onsdag","Torsdag","Fredag","L√∏rdag"];
  const dkMonths = ["januar","februar","marts","april","maj","juni","juli","august","september","oktober","november","december"];

  function dayPart(h){
    if (h >= 5 && h < 9)  return "Morgen";
    if (h >= 9 && h < 12) return "Formiddag";
    if (h >= 12 && h < 17) return "Eftermiddag";
    if (h >= 17 && h < 22) return "Aften";
    return "Nat";
  }
  function pad2(n){ return String(n).padStart(2,"0"); }

  function tickClock(){
    const now = new Date();
    document.getElementById("weekdayBig").textContent = dkWeekdays[now.getDay()];
    document.getElementById("dateLine").textContent = `${now.getDate()}. ${dkMonths[now.getMonth()]} ${now.getFullYear()}`;
    document.getElementById("timeLine").textContent = `${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
    document.getElementById("dayPartLine").textContent = dayPart(now.getHours());
  }
  tickClock();
  setInterval(tickClock, 1000);

  // --- VEJR (Open-Meteo: ingen n√∏gle)
  const weatherCodeMap = {
    0: ["Klart", "‚òÄÔ∏è"],
    1: ["Mest klart", "üå§Ô∏è"],
    2: ["Let skyet", "‚õÖ"],
    3: ["Overskyet", "‚òÅÔ∏è"],
    45: ["T√•ge", "üå´Ô∏è"],
    48: ["T√•ge", "üå´Ô∏è"],
    51: ["St√∏vregn", "üå¶Ô∏è"],
    53: ["St√∏vregn", "üå¶Ô∏è"],
    55: ["St√∏vregn", "üåßÔ∏è"],
    61: ["Regn", "üåßÔ∏è"],
    63: ["Regn", "üåßÔ∏è"],
    65: ["Kraftig regn", "üåßÔ∏è"],
    71: ["Sne", "üå®Ô∏è"],
    73: ["Sne", "üå®Ô∏è"],
    75: ["Kraftig sne", "üå®Ô∏è"],
    80: ["Byger", "üå¶Ô∏è"],
    81: ["Byger", "üå¶Ô∏è"],
    82: ["Kraftige byger", "‚õàÔ∏è"],
    95: ["Torden", "‚õàÔ∏è"],
    96: ["Torden + hagl", "‚õàÔ∏è"],
    99: ["Torden + hagl", "‚õàÔ∏è"]
  };

  function fmtHHMM(d){
    return d.toLocaleTimeString("da-DK", {hour:"2-digit", minute:"2-digit"});
  }

  // -------- Auto-recovery / "browser-genstart"
  let consecutiveFailures = 0;
  let retryTimer = null;

  // Reload-sikring (undg√• reload-loop)
  const RELOAD_COOLDOWN_MS = 5 * 60 * 1000; // min 5 min mellem reloads
  const MAX_RELOADS_PER_HOUR = 3;

  function canReloadNow(){
    const now = Date.now();

    const lastReload = Number(sessionStorage.getItem("lastReloadTs") || "0");
    if (now - lastReload < RELOAD_COOLDOWN_MS) return false;

    // track reloads i den seneste time
    const history = JSON.parse(sessionStorage.getItem("reloadHistory") || "[]")
      .filter(ts => now - ts < 60 * 60 * 1000);

    if (history.length >= MAX_RELOADS_PER_HOUR) return false;

    history.push(now);
    sessionStorage.setItem("reloadHistory", JSON.stringify(history));
    sessionStorage.setItem("lastReloadTs", String(now));
    return true;
  }

  function softRestartPage(reason){
    console.warn("Soft restart:", reason);
    if (canReloadNow()){
      location.reload();
    } else {
      // hvis vi ikke m√• reload'e (for at undg√• loop), s√• pr√∏v blot igen om lidt
      scheduleRetry(60 * 1000);
    }
  }

  function scheduleRetry(ms){
    if (retryTimer) clearTimeout(retryTimer);
    retryTimer = setTimeout(() => {
      fetchWeather({ fromRetry: true });
    }, ms);
  }

  async function fetchWeather(opts = {}){
    // Hvis browseren melder "offline", s√• vent og pr√∏v igen (ingen fejlspam)
    if (!navigator.onLine){
      document.getElementById("weatherSummary").textContent = "Ingen internetforbindelse";
      document.getElementById("weatherIcon").textContent = "‚ö†Ô∏è";
      consecutiveFailures++;
      scheduleRetry(30 * 1000);
      return;
    }

    const url =
      `https://api.open-meteo.com/v1/forecast` +
      `?latitude=${LAT}&longitude=${LON}` +
      `&current=temperature_2m,weather_code` +
      `&timezone=Europe%2FCopenhagen`;

    try{
      // Timeout s√• fetch ikke kan h√¶nge "for evigt"
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), 8000);

      const r = await fetch(url, { cache: "no-store", signal: ctrl.signal });
      clearTimeout(t);

      if(!r.ok) throw new Error("HTTP " + r.status);

      const data = await r.json();
      const c = data.current;

      const temp = c.temperature_2m;
      const wcode = c.weather_code;
      const [desc, icon] = weatherCodeMap[wcode] || ["Vejr", "‚õÖ"];

      document.getElementById("weatherSummary").textContent = desc;
      document.getElementById("weatherIcon").textContent = icon;
      document.getElementById("tempLine").textContent = `${Math.round(temp)}¬∞`;

      document.getElementById("updatedLine").textContent = `Sidst opdateret: ${fmtHHMM(new Date())}`;

      consecutiveFailures = 0; // succes -> nulstil

    }catch(err){
      consecutiveFailures++;
      console.warn("Weather fetch failed:", err);

      // Vis fejl (som f√∏r)
      document.getElementById("weatherSummary").textContent = "Kunne ikke hente vejr";
      document.getElementById("weatherIcon").textContent = "‚ö†Ô∏è";

      // Retry strategi:
      // 1-2 fejl: pr√∏v igen snart
      // 3-4 fejl: pr√∏v igen lidt senere
      // 5+ fejl: genindl√¶s siden (soft restart)
      if (consecutiveFailures <= 2){
        scheduleRetry(20 * 1000);
      } else if (consecutiveFailures <= 4){
        scheduleRetry(60 * 1000);
      } else {
        softRestartPage("Too many consecutive weather failures");
      }
    }
  }

  // --- OPDATER KUN P√Ö KVARTER: :00, :15, :30, :45 (lokal tid)
  function msUntilNextQuarter(){
    const now = new Date();
    const minutes = now.getMinutes();
    const nextQuarterMin = (Math.floor(minutes / 15) + 1) * 15;

    const next = new Date(now);
    if (nextQuarterMin >= 60){
      next.setHours(now.getHours() + 1, 0, 0, 0);
    } else {
      next.setMinutes(nextQuarterMin, 0, 0);
    }
    return next.getTime() - now.getTime();
  }

  function scheduleQuarterUpdates(){
    // Hent straks ved start
    fetchWeather();

    // Planl√¶g n√¶ste pr√¶cise kvart
    setTimeout(function(){
      fetchWeather();
      setInterval(fetchWeather, 15 * 60 * 1000);
    }, msUntilNextQuarter());
  }

  // N√•r nettet kommer tilbage, s√• hent igen med det samme (og stop evt. retry-timer)
  window.addEventListener("online", () => {
    if (retryTimer) clearTimeout(retryTimer);
    retryTimer = null;
    fetchWeather({ fromOnline: true });
  });

  // Hvis den g√•r offline, vis en mere meningsfuld tekst med det samme
  window.addEventListener("offline", () => {
    document.getElementById("weatherSummary").textContent = "Ingen internetforbindelse";
    document.getElementById("weatherIcon").textContent = "‚ö†Ô∏è";
  });

  scheduleQuarterUpdates();
</script>
</body>
</html>
